name: CI (Lean)

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  gate:
    name: Verify & Lint
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: ['18', '20']
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Cache npm cache
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-cache-${{ runner.os }}-node-${{ matrix.node-version }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            npm-cache-${{ runner.os }}-node-${{ matrix.node-version }}-

      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node-modules-${{ runner.os }}-node-${{ matrix.node-version }}-${{ hashFiles('package-lock.json') }}

      - run: npm ci --prefer-offline
        if: steps.cache-node-modules.outputs.cache-hit != 'true'

      - name: Run verify gate (harness + IR validation + parity + determinism)
        run: npm run verify

      - name: Run static warnings gate (Lua lint budget 0)
        run: npm run static:warnings

      - name: Lint source code (warning-only for now)
        run: npm run lint || true
        continue-on-error: true

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-node-${{ matrix.node-version }}
          path: |
            harness_results.json
            reports/
            perf_results.txt
          retention-days: 7
          if-no-files-found: ignore

  comment-results:
    name: Comment PR with results
    runs-on: ubuntu-latest
    needs: gate
    if: always() && github.event_name == 'pull_request'
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: results-node-18
          path: ./results

      - name: Post results comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            let comment = '## âœ… CI Gate Results\n\n';
            
            // Check harness results
            if (fs.existsSync('./results/harness_results.json')) {
              try {
                const harness = JSON.parse(fs.readFileSync('./results/harness_results.json', 'utf8'));
                comment += `### Harness\n- Tests passed: ${harness.total}\n\n`;
              } catch (e) {}
            }
            
            comment += '**CI gates passed** - Ready for review and auto-merge if approved.\n';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
