name: matrix-audit

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

concurrency:
  group: matrix-audit-${{ github.ref }}
  cancel-in-progress: true

jobs:
  matrix-run:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        seed: [1001, 1002, 1003, 2001, 2002, 2003, 3001, 3002, 3003]
        axisA_tag: [boundary, typical, adversarial]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Enhanced transpiler sweep
        env:
          LUASCRIPT_SEED: ${{ matrix.seed }}
          AXIS_A_TAG: ${{ matrix.axisA_tag }}
        run: node test/test_enhanced_transpiler.js

      - name: IR validation
        run: npm run -s ir:validate:all

      - name: Emit goldens parity
        run: npm run -s ir:emit:goldens

      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: matrix-${{ matrix.seed }}-${{ matrix.axisA_tag }}
          path: |
            reports/
            test_report.txt
            static_warnings*.txt

  emit-ir-check:
    needs: matrix-run
    runs-on: ubuntu-latest
    strategy:
      matrix:
        seed: [4001, 4002, 4003]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: IR status report
        env:
          LUASCRIPT_SEED: ${{ matrix.seed }}
        run: npm run -s ir:report

      - name: Golden IR parity
        run: npm run -s ir:golden:parity

      - name: Upload IR reports on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ir-status-${{ matrix.seed }}
          path: reports/

  harness-check:
    needs:
      - matrix-run
      - emit-ir-check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Run IR harness tests
        run: node tests/ir/harness.test.js

      - name: Upload harness artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: harness-artifacts
          path: |
            artifacts/
            reports/
            tests/tmp/
          if-no-files-found: ignore
